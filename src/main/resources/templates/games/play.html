<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <title th:text="${'게임 플레이 - ' + gameType}">게임 플레이</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
<div th:replace="~{layout/base :: layout('게임 플레이', ~{::content})}">
    <div id="content" th:fragment="content">
        <section class="card border-0 shadow-sm p-3">
            <div class="d-flex align-items-center justify-content-between gap-3">
                <div>
                    <div class="fw-bold">게임: <span id="gameTypeView" th:text="${gameType}">COLOR_TAP</span></div>
                    <div class="small text-muted">세션: <span id="sessionView">-</span></div>
                </div>
                <div class="d-flex gap-2">
                    <button id="btnStart" class="btn btn-primary">게임 시작</button>
                    <a class="btn btn-outline-secondary" href="/game">목록</a>
                    <button id="btnEnd" class="btn btn-outline-primary">종료</button>
                </div>
            </div>
            <div class="mt-2 d-flex gap-4">
                <div>점수: <span id="scoreView">0</span></div>
                <div>정확도: <span id="accView">0%</span></div>
                <div>남은시간: <span id="timeView">0s</span></div>
            </div>
        </section>

        <section class="card border-0 shadow-sm p-3 mt-3">
            <div id="gameArea" style="min-height:260px"></div>
            <pre id="log" class="mt-3 small text-muted"></pre>
        </section>
    </div>
</div>
<!-- 게임 로딩/세션 생성/종료 제어 -->
<script type="module">
    import { isAuthed } from '/js/app.esm.js';
    import { start as startSession, end as endSession, safeEndOnLeave } from '/js/game-bridge.esm.js';

    // 진입 가드: 비로그인 → 로그인 페이지로
    const nextUrl = location.pathname + location.search;
    if (!isAuthed()) {
      try { sessionStorage.setItem('next', nextUrl); } catch {}
      location.replace('/login?next=' + encodeURIComponent(nextUrl));
    }

    const $ = (id) => document.getElementById(id);

    function gameModulePath(t) {
      switch (t) {
        case 'COLOR_TAP':       return '/js/games/color-tap.js';
        case 'SEQUENCE_MEMORY': return '/js/games/sequence-memory.js';
        case 'SHAPE_MATCH':     return '/js/games/shape-match.js';
        default:                return null;
      }
    }

    function gamePartialPath(t) {
      switch (t) {
        case 'COLOR_TAP':       return '/games/color-tap.html';
        case 'SEQUENCE_MEMORY': return '/games/sequence-memory.html';
        case 'SHAPE_MATCH':     return '/games/shape-match.html';
        default:                return null;
      }
    }

    async function loadPartial(url, host) {
      if (!url) return;
      const html = await fetch(url, { cache: 'no-cache' }).then(r => r.text());
      host.innerHTML = html;
    }

    // ---------------------------
    // 초기: 준비 화면만 로드
    // ---------------------------
    let booted = false;       // 중복 시작 방지
    let currentSid = null;    // 현재 세션ID

    async function preloadUI() {
      const type = $('gameTypeView').textContent.trim();
      const partial = gamePartialPath(type);
      if (!partial) {
        alert('아직 구현되지 않은 게임입니다.');
        location.href = '/game';
        return;
      }
      // 페이지 진입 즉시 준비 화면 렌더
      await loadPartial(partial, $('gameArea'));

      // 준비 화면 상태값 뷰 업데이트 (보기 좋게)
      $('timeView').textContent = '30s';
      $('scoreView').textContent = '0';
      $('accView').textContent = '0%';
    }

    // ---------------------------
    // 실제 게임 시작(세션 생성 + 모듈 start)
    // ---------------------------
    async function boot() {
      if (booted) return;  // 중복 클릭 방지
      booted = true;

      try {
        const type = $('gameTypeView').textContent.trim();
        const jsPath = gameModulePath(type);
        if (!jsPath) { alert('아직 구현되지 않은 게임입니다.'); location.href='/game'; return; }

        // 모듈 사전 로딩(파셜은 이미 로딩됨)
        const mod = await import(jsPath + '?v=1');
        const game = mod.default || mod[Object.keys(mod)[0]];
        if (!game?.start) { throw new Error('게임 모듈에 start 함수가 없습니다.'); }

        // 세션 생성
        const s = await startSession(type);
        const sid = s.sessionId;
        currentSid = sid;
        $('sessionView').textContent = sid;

        // 게임 시작
        game.start(sid, {
          onScore: (score, acc) => {
            $('scoreView').textContent = String(score);
            $('accView').textContent = `${Math.round((acc||0)*100)}%`;
          },
          onTime: (sec) => { $('timeView').textContent = `${sec}s`; },
          onEnd: async (payload) => {
            try {
              const r = await endSession(sid, payload || {});
              $('log').textContent = '종료 기록: ' + JSON.stringify(r, null, 2);
            } finally {
              sessionStorage.removeItem('sessionId');
              currentSid = null;
              booted = false; // 다시 시작 가능
            }
          }
        });

      } catch (e) {
        console.error(e);
        alert('게임 시작 중 오류: ' + e);
        location.href = '/game';
      }
    }

    // ---------------------------
    // 종료/이탈 처리
    // ---------------------------
    $('btnEnd')?.addEventListener('click', async () => {
      try {
        if (currentSid) await endSession(currentSid, {});
      } finally {
        sessionStorage.removeItem('sessionId');
        currentSid = null;
        location.href = '/game';
      }
    });
    window.addEventListener('pagehide', () => safeEndOnLeave());

    // ---------------------------
    // 이벤트 바인딩
    // ---------------------------
    $('btnStart')?.addEventListener('click', () => boot());

    // 페이지 진입 즉시 "준비 화면"만 렌더
    document.addEventListener('DOMContentLoaded', preloadUI);
</script>
</body>
</html>