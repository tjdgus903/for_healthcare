<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Shape Match | Healthcare</title>
    <style>
        :root { --btn-size: 120px; --gap: 12px; }
        body { font-family: system-ui, sans-serif; max-width: 960px; margin: 24px auto; padding: 0 12px; }
        h1 { margin: 8px 0 16px; }
        .card { border:1px solid #ddd; border-radius:12px; padding:16px; margin:12px 0; }
        .row, .panel { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
        input, button, select { padding:10px 12px; border:1px solid #bbb; border-radius:10px; font-size:16px; }
        button { cursor:pointer; }
        .grid { display:grid; gap: var(--gap); margin-top: 12px; }
        .cell {
          width: 100%; height: var(--btn-size);
          border-radius: 16px; border: 2px solid #222;
          display:flex; align-items:center; justify-content:center;
          font-weight: 800; font-size: 24px; background:#f7f7f7; touch-action: manipulation;
        }
        .big .cell { height: calc(var(--btn-size) * 1.4); font-size: 26px; }
        .badge { background:#efefef; padding:6px 10px; border-radius:999px; }
        .target {
          display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid #ccc;
          background:#fff;
        }
    </style>
    <script defer src="/games/common.js"></script>
</head>
<body>
<h1>🔷 Shape Match</h1>

<div class="card" aria-labelledby="loginTitle">
    <h3 id="loginTitle">1) 로그인</h3>
    <div class="row">
        <label>아이디 <input id="id" value="fhc"/></label>
        <label>비밀번호 <input id="pw" value="fhc" type="password"/></label>
        <button id="btnLogin">로그인</button>
        <button id="btnLogout">로그아웃</button>
        <span id="loginStatus" class="badge" aria-live="polite"></span>
    </div>
</div>

<a href="/games/shape-match.html"><button>🔷 Shape Match</button></a>

<div class="card" aria-labelledby="optTitle">
    <h3 id="optTitle">2) 옵션</h3>
    <div class="panel">
        <label>행(rows)
            <select id="optRows">
                <option value="2" selected>2</option>
                <option value="3">3</option>
            </select>
        </label>
        <label>열(cols)
            <select id="optCols">
                <option value="2" selected>2</option>
                <option value="3">3</option>
            </select>
        </label>
        <label>라운드 수
            <select id="optRounds">
                <option value="6" selected>6</option>
                <option value="8">8</option>
                <option value="10">10</option>
            </select>
        </label>
        <label>입력 제한(ms)
            <select id="optTimeout">
                <option value="5000" selected>5000</option>
                <option value="4000">4000</option>
                <option value="3000">3000</option>
            </select>
        </label>
        <label><input type="checkbox" id="optBig"/> 큰 버튼</label>
    </div>
</div>

<div class="card" aria-labelledby="playTitle">
    <h3 id="playTitle">3) 플레이</h3>
    <div class="panel">
        <button id="btnStart">시작</button>
        <div class="target">타깃: <span id="targetShape">-</span></div>
        <div class="badge">라운드: <span id="round">-</span></div>
        <div class="badge">정답: <span id="hit">0</span></div>
        <div class="badge">오답: <span id="miss">0</span></div>
        <div class="badge">평균반응(ms): <span id="avgMs">-</span></div>
    </div>

    <div id="grid" class="grid" style="margin-top:12px;"></div>

    <div class="panel" style="margin-top:12px;">
        <button id="btnEnd" disabled>강제 종료/기록</button>
        <span id="status" class="badge" aria-live="polite"></span>
    </div>
</div>

<script>
    (() => {
      const $ = (id) => document.getElementById(id);

      const SHAPE_LABELS = {
        'CIRCLE': '●',
        'TRIANGLE': '▲',
        'SQUARE': '■',
        'STAR': '★'
      };

      let sessionId = null;
      let rows = 2, cols = 2, totalRounds = 6, timeoutMs = 5000;
      let roundIndex = 0;
      let hit = 0, miss = 0;
      let reactions = [];
      let target = null;        // 서버가 준 타깃 문자열
      let targetIndex = -1;     // 서버에서 계산되는 인덱스(제출 응답에 포함)
      let startedAt = 0;

      function reset() {
        sessionId = null;
        roundIndex = 0;
        hit = 0; miss = 0; reactions = [];
        $('round').textContent = '-';
        $('hit').textContent = '0';
        $('miss').textContent = '0';
        $('avgMs').textContent = '-';
        $('targetShape').textContent = '-';
        $('status').textContent = '';
        $('grid').innerHTML = '';
        $('btnEnd').disabled = true;
      }

      function setStats() {
        $('hit').textContent = String(hit);
        $('miss').textContent = String(miss);
        const avg = reactions.length ? Math.round(reactions.reduce((a,b)=>a+b,0)/reactions.length) : '-';
        $('avgMs').textContent = String(avg);
      }

      // 로그인/로그아웃
      $('btnLogin').addEventListener('click', async () => {
        try {
          await API.login($('id').value, $('pw').value);
          $('loginStatus').textContent = '로그인 성공';
        } catch(e) {
          $('loginStatus').textContent = '로그인 실패';
        }
      });
      $('btnLogout').addEventListener('click', () => {
        API.clearToken();
        $('loginStatus').textContent = '로그아웃 완료';
      });

      // 옵션
      $('optBig').addEventListener('change', e => {
        document.body.classList.toggle('big', e.target.checked);
      });

      // 시작
      $('btnStart').addEventListener('click', async () => {
        if (!API.getToken()) { alert('먼저 로그인하세요.'); return; }
        try {
          reset();
          rows = parseInt($('optRows').value, 10);
          cols = parseInt($('optCols').value, 10);
          totalRounds = parseInt($('optRounds').value, 10);
          timeoutMs = parseInt($('optTimeout').value, 10);

          const res = await API.request('/shape/start', {
            method: 'POST',
            body: { rows, cols, totalRounds, shapeSet: Object.keys(SHAPE_LABELS), inputTimeoutMs: timeoutMs }
          });
          sessionId = res.sessionId;
          $('btnEnd').disabled = false;
          roundIndex = res.roundIndex;
          $('round').textContent = `${roundIndex}/${totalRounds}`;
          target = res.target;
          $('targetShape').textContent = SHAPE_LABELS[target] || target;

          renderGrid(res.cells);
          startedAt = performance.now();
          scheduleTimeout();
        } catch (e) {
          alert('시작 실패: ' + e.message);
        }
      });

      // 강제 종료
      $('btnEnd').addEventListener('click', async () => {
        if (sessionId) await finalize();
      });

      // 그리드 렌더
      function renderGrid(cells) {
        const grid = $('grid');
        grid.style.gridTemplateColumns = `repeat(${cols}, minmax(100px, 1fr))`;
        grid.innerHTML = '';
        cells.forEach((shape, idx) => {
          const btn = document.createElement('button');
          btn.className = 'cell';
          btn.setAttribute('data-index', String(idx));
          btn.setAttribute('aria-label', shape);
          btn.textContent = SHAPE_LABELS[shape] || shape;
          btn.addEventListener('pointerdown', onPick, {passive:true});
          btn.addEventListener('keydown', e => { if (e.key==='Enter'||e.key===' ') onPick(e); });
          grid.appendChild(btn);
        });
      }

      async function onPick(e) {
        if (!sessionId) return;
        const idx = parseInt(e.currentTarget.getAttribute('data-index'), 10);
        const reactionMs = Math.round(performance.now() - startedAt);
        try {
          const r = await API.request(`/shape/${sessionId}/submit`, {
            method: 'POST',
            body: { roundIndex, chosenIndex: idx, reactionMs }
          });
          if (r.correct) hit++; else miss++;
          reactions.push(reactionMs);
          setStats();

          if (r.finished) {
            await finalize();
          } else {
            // 다음 라운드 레이아웃 받아 계속
            roundIndex = r.nextRound;
            $('round').textContent = `${roundIndex}/${totalRounds}`;
            const lay = await API.request(`/shape/${sessionId}/layout?roundIndex=${roundIndex}`);
            target = lay.target;
            $('targetShape').textContent = SHAPE_LABELS[target] || target;
            renderGrid(lay.cells);
            startedAt = performance.now();
            scheduleTimeout();
          }
        } catch (e) {
          $('status').textContent = '제출 실패: ' + e.message;
        }
      }

      function scheduleTimeout() {
        if (!timeoutMs || timeoutMs <= 0) return;
        const thisRound = roundIndex;
        setTimeout(async () => {
          // 이미 라운드가 넘어갔거나 종료된 경우 무시
          if (!sessionId || thisRound !== roundIndex) return;
          try {
            const r = await API.request(`/shape/${sessionId}/submit`, {
              method: 'POST',
              body: { roundIndex, chosenIndex: -1, reactionMs: timeoutMs }
            });
            // 제한시간 초과는 오답으로 처리됨
            if (r.correct) hit++; else miss++;
            reactions.push(timeoutMs);
            setStats();

            if (r.finished) {
              await finalize();
            } else {
              const lay = await API.request(`/shape/${sessionId}/layout?roundIndex=${r.nextRound}`);
              roundIndex = r.nextRound;
              $('round').textContent = `${roundIndex}/${totalRounds}`;
              target = lay.target;
              $('targetShape').textContent = SHAPE_LABELS[target] || target;
              renderGrid(lay.cells);
              startedAt = performance.now();
              scheduleTimeout();
            }
          } catch (e) {
            $('status').textContent = '제출 실패(타임아웃): ' + e.message;
          }
        }, timeoutMs);
      }

      async function finalize() {
        const avg = reactions.length ? Math.round(reactions.reduce((a,b)=>a+b,0)/reactions.length) : null;
        try {
          const res = await API.request(`/shape/${sessionId}/end`, {
            method: 'POST',
            body: { totalRounds, hitCount: hit, missCount: miss, avgReactionMs: avg }
          });
          $('status').textContent = `기록 저장: 점수 ${res.score}, 정확도 ${Math.round((res.accuracy ?? 0)*100)}%`;
        } catch (e) {
          $('status').textContent = '기록 실패: ' + e.message;
        } finally {
          $('btnEnd').disabled = true;
        }
      }
    })();
</script>
</body>
</html>