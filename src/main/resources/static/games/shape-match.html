<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Shape Match | Healthcare</title>
    <style>
        :root { --btn-size: 120px; --gap: 12px; }
        body { font-family: system-ui, sans-serif; max-width: 960px; margin: 24px auto; padding: 0 12px; }
        h1 { margin: 8px 0 16px; }
        .card { border:1px solid #ddd; border-radius:12px; padding:16px; margin:12px 0; }
        .row, .panel { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
        input, button, select { padding:10px 12px; border:1px solid #bbb; border-radius:10px; font-size:16px; }
        button { cursor:pointer; }
        .grid { display:grid; gap: var(--gap); margin-top: 12px; }
        .cell {
          width: 100%; height: var(--btn-size);
          border-radius: 16px; border: 2px solid #222;
          display:flex; align-items:center; justify-content:center;
          font-weight: 800; font-size: 24px; background:#f7f7f7; touch-action: manipulation;
        }
        .big .cell { height: calc(var(--btn-size) * 1.4); font-size: 26px; }
        .badge { background:#efefef; padding:6px 10px; border-radius:999px; }
        .target {
          display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid #ccc;
          background:#fff;
        }
    </style>
    <script defer src="/games/common.js"></script>
</head>
<body>
<h1>ğŸ”· Shape Match</h1>

<div class="card" aria-labelledby="loginTitle">
    <h3 id="loginTitle">1) ë¡œê·¸ì¸</h3>
    <div class="row">
        <label>ì•„ì´ë”” <input id="id" value="fhc"/></label>
        <label>ë¹„ë°€ë²ˆí˜¸ <input id="pw" value="fhc" type="password"/></label>
        <button id="btnLogin">ë¡œê·¸ì¸</button>
        <button id="btnLogout">ë¡œê·¸ì•„ì›ƒ</button>
        <span id="loginStatus" class="badge" aria-live="polite"></span>
    </div>
</div>

<a href="/games/shape-match.html"><button>ğŸ”· Shape Match</button></a>

<div class="card" aria-labelledby="optTitle">
    <h3 id="optTitle">2) ì˜µì…˜</h3>
    <div class="panel">
        <label>í–‰(rows)
            <select id="optRows">
                <option value="2" selected>2</option>
                <option value="3">3</option>
            </select>
        </label>
        <label>ì—´(cols)
            <select id="optCols">
                <option value="2" selected>2</option>
                <option value="3">3</option>
            </select>
        </label>
        <label>ë¼ìš´ë“œ ìˆ˜
            <select id="optRounds">
                <option value="6" selected>6</option>
                <option value="8">8</option>
                <option value="10">10</option>
            </select>
        </label>
        <label>ì…ë ¥ ì œí•œ(ms)
            <select id="optTimeout">
                <option value="5000" selected>5000</option>
                <option value="4000">4000</option>
                <option value="3000">3000</option>
            </select>
        </label>
        <label><input type="checkbox" id="optBig"/> í° ë²„íŠ¼</label>
    </div>
</div>

<div class="card" aria-labelledby="playTitle">
    <h3 id="playTitle">3) í”Œë ˆì´</h3>
    <div class="panel">
        <button id="btnStart">ì‹œì‘</button>
        <div class="target">íƒ€ê¹ƒ: <span id="targetShape">-</span></div>
        <div class="badge">ë¼ìš´ë“œ: <span id="round">-</span></div>
        <div class="badge">ì •ë‹µ: <span id="hit">0</span></div>
        <div class="badge">ì˜¤ë‹µ: <span id="miss">0</span></div>
        <div class="badge">í‰ê· ë°˜ì‘(ms): <span id="avgMs">-</span></div>
    </div>

    <div id="grid" class="grid" style="margin-top:12px;"></div>

    <div class="panel" style="margin-top:12px;">
        <button id="btnEnd" disabled>ê°•ì œ ì¢…ë£Œ/ê¸°ë¡</button>
        <span id="status" class="badge" aria-live="polite"></span>
    </div>
</div>

<script>
    (() => {
      const $ = (id) => document.getElementById(id);

      const SHAPE_LABELS = {
        'CIRCLE': 'â—',
        'TRIANGLE': 'â–²',
        'SQUARE': 'â– ',
        'STAR': 'â˜…'
      };

      let sessionId = null;
      let rows = 2, cols = 2, totalRounds = 6, timeoutMs = 5000;
      let roundIndex = 0;
      let hit = 0, miss = 0;
      let reactions = [];
      let target = null;        // ì„œë²„ê°€ ì¤€ íƒ€ê¹ƒ ë¬¸ìì—´
      let targetIndex = -1;     // ì„œë²„ì—ì„œ ê³„ì‚°ë˜ëŠ” ì¸ë±ìŠ¤(ì œì¶œ ì‘ë‹µì— í¬í•¨)
      let startedAt = 0;

      function reset() {
        sessionId = null;
        roundIndex = 0;
        hit = 0; miss = 0; reactions = [];
        $('round').textContent = '-';
        $('hit').textContent = '0';
        $('miss').textContent = '0';
        $('avgMs').textContent = '-';
        $('targetShape').textContent = '-';
        $('status').textContent = '';
        $('grid').innerHTML = '';
        $('btnEnd').disabled = true;
      }

      function setStats() {
        $('hit').textContent = String(hit);
        $('miss').textContent = String(miss);
        const avg = reactions.length ? Math.round(reactions.reduce((a,b)=>a+b,0)/reactions.length) : '-';
        $('avgMs').textContent = String(avg);
      }

      // ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ
      $('btnLogin').addEventListener('click', async () => {
        try {
          await API.login($('id').value, $('pw').value);
          $('loginStatus').textContent = 'ë¡œê·¸ì¸ ì„±ê³µ';
        } catch(e) {
          $('loginStatus').textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
        }
      });
      $('btnLogout').addEventListener('click', () => {
        API.clearToken();
        $('loginStatus').textContent = 'ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ';
      });

      // ì˜µì…˜
      $('optBig').addEventListener('change', e => {
        document.body.classList.toggle('big', e.target.checked);
      });

      // ì‹œì‘
      $('btnStart').addEventListener('click', async () => {
        if (!API.getToken()) { alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.'); return; }
        try {
          reset();
          rows = parseInt($('optRows').value, 10);
          cols = parseInt($('optCols').value, 10);
          totalRounds = parseInt($('optRounds').value, 10);
          timeoutMs = parseInt($('optTimeout').value, 10);

          const res = await API.request('/shape/start', {
            method: 'POST',
            body: { rows, cols, totalRounds, shapeSet: Object.keys(SHAPE_LABELS), inputTimeoutMs: timeoutMs }
          });
          sessionId = res.sessionId;
          $('btnEnd').disabled = false;
          roundIndex = res.roundIndex;
          $('round').textContent = `${roundIndex}/${totalRounds}`;
          target = res.target;
          $('targetShape').textContent = SHAPE_LABELS[target] || target;

          renderGrid(res.cells);
          startedAt = performance.now();
          scheduleTimeout();
        } catch (e) {
          alert('ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
        }
      });

      // ê°•ì œ ì¢…ë£Œ
      $('btnEnd').addEventListener('click', async () => {
        if (sessionId) await finalize();
      });

      // ê·¸ë¦¬ë“œ ë Œë”
      function renderGrid(cells) {
        const grid = $('grid');
        grid.style.gridTemplateColumns = `repeat(${cols}, minmax(100px, 1fr))`;
        grid.innerHTML = '';
        cells.forEach((shape, idx) => {
          const btn = document.createElement('button');
          btn.className = 'cell';
          btn.setAttribute('data-index', String(idx));
          btn.setAttribute('aria-label', shape);
          btn.textContent = SHAPE_LABELS[shape] || shape;
          btn.addEventListener('pointerdown', onPick, {passive:true});
          btn.addEventListener('keydown', e => { if (e.key==='Enter'||e.key===' ') onPick(e); });
          grid.appendChild(btn);
        });
      }

      async function onPick(e) {
        if (!sessionId) return;
        const idx = parseInt(e.currentTarget.getAttribute('data-index'), 10);
        const reactionMs = Math.round(performance.now() - startedAt);
        try {
          const r = await API.request(`/shape/${sessionId}/submit`, {
            method: 'POST',
            body: { roundIndex, chosenIndex: idx, reactionMs }
          });
          if (r.correct) hit++; else miss++;
          reactions.push(reactionMs);
          setStats();

          if (r.finished) {
            await finalize();
          } else {
            // ë‹¤ìŒ ë¼ìš´ë“œ ë ˆì´ì•„ì›ƒ ë°›ì•„ ê³„ì†
            roundIndex = r.nextRound;
            $('round').textContent = `${roundIndex}/${totalRounds}`;
            const lay = await API.request(`/shape/${sessionId}/layout?roundIndex=${roundIndex}`);
            target = lay.target;
            $('targetShape').textContent = SHAPE_LABELS[target] || target;
            renderGrid(lay.cells);
            startedAt = performance.now();
            scheduleTimeout();
          }
        } catch (e) {
          $('status').textContent = 'ì œì¶œ ì‹¤íŒ¨: ' + e.message;
        }
      }

      function scheduleTimeout() {
        if (!timeoutMs || timeoutMs <= 0) return;
        const thisRound = roundIndex;
        setTimeout(async () => {
          // ì´ë¯¸ ë¼ìš´ë“œê°€ ë„˜ì–´ê°”ê±°ë‚˜ ì¢…ë£Œëœ ê²½ìš° ë¬´ì‹œ
          if (!sessionId || thisRound !== roundIndex) return;
          try {
            const r = await API.request(`/shape/${sessionId}/submit`, {
              method: 'POST',
              body: { roundIndex, chosenIndex: -1, reactionMs: timeoutMs }
            });
            // ì œí•œì‹œê°„ ì´ˆê³¼ëŠ” ì˜¤ë‹µìœ¼ë¡œ ì²˜ë¦¬ë¨
            if (r.correct) hit++; else miss++;
            reactions.push(timeoutMs);
            setStats();

            if (r.finished) {
              await finalize();
            } else {
              const lay = await API.request(`/shape/${sessionId}/layout?roundIndex=${r.nextRound}`);
              roundIndex = r.nextRound;
              $('round').textContent = `${roundIndex}/${totalRounds}`;
              target = lay.target;
              $('targetShape').textContent = SHAPE_LABELS[target] || target;
              renderGrid(lay.cells);
              startedAt = performance.now();
              scheduleTimeout();
            }
          } catch (e) {
            $('status').textContent = 'ì œì¶œ ì‹¤íŒ¨(íƒ€ì„ì•„ì›ƒ): ' + e.message;
          }
        }, timeoutMs);
      }

      async function finalize() {
        const avg = reactions.length ? Math.round(reactions.reduce((a,b)=>a+b,0)/reactions.length) : null;
        try {
          const res = await API.request(`/shape/${sessionId}/end`, {
            method: 'POST',
            body: { totalRounds, hitCount: hit, missCount: miss, avgReactionMs: avg }
          });
          $('status').textContent = `ê¸°ë¡ ì €ì¥: ì ìˆ˜ ${res.score}, ì •í™•ë„ ${Math.round((res.accuracy ?? 0)*100)}%`;
        } catch (e) {
          $('status').textContent = 'ê¸°ë¡ ì‹¤íŒ¨: ' + e.message;
        } finally {
          $('btnEnd').disabled = true;
        }
      }
    })();
</script>
</body>
</html>