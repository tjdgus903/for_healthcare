<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Color Tap | Healthcare</title>
    <link rel="preconnect" href="/">
    <style>
        :root {
          --btn-size: 120px;       /* í° ë²„íŠ¼ ê¸°ë³¸ í¬ê¸° */
          --gap: 12px;
        }
        body { font-family: system-ui, sans-serif; max-width: 960px; margin: 24px auto; padding: 0 12px; }
        h1 { margin: 8px 0 16px; }
        .card { border:1px solid #ddd; border-radius:12px; padding:16px; margin:12px 0; }
        .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
        input, button, select { padding:10px 12px; border:1px solid #bbb; border-radius:10px; font-size:16px; }
        button { cursor:pointer; }
        .grid { display:grid; grid-template-columns: repeat(2, minmax(120px, 1fr)); gap: var(--gap); margin-top: 12px; }
        .color-btn {
          height: var(--btn-size);
          border-radius: 16px;
          display:flex; align-items:center; justify-content:center;
          font-weight: 700; color: #111; border:2px solid #222;
          touch-action: manipulation;
        }
        .panel { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
        .badge { background:#efefef; padding:6px 10px; border-radius:999px; }
        .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
        .contrast .color-btn { border-color:#000; }
        .contrast #targetSwatch { box-shadow: 0 0 0 4px #000 inset; }
        .big .color-btn { height: calc(var(--btn-size) * 1.4); font-size: 20px; }
    </style>
    <script defer src="/games/common.js"></script>
</head>
<body>
<h1>ğŸ¯ Color Tap</h1>

<div class="card" aria-labelledby="loginTitle">
    <h3 id="loginTitle">1) ë¡œê·¸ì¸</h3>
    <div class="row">
        <label>ì•„ì´ë”” <input id="id" value="fhc"/></label>
        <label>ë¹„ë°€ë²ˆí˜¸ <input id="pw" value="fhc" type="password"/></label>
        <button id="btnLogin">ë¡œê·¸ì¸</button>
        <span id="loginStatus" class="badge" aria-live="polite"></span>
    </div>
</div>

<div class="card" aria-labelledby="optTitle">
    <h3 id="optTitle">2) ì ‘ê·¼ì„± & ê²Œì„ ì˜µì…˜</h3>
    <div class="panel">
        <label><input type="checkbox" id="optContrast"/> ê³ ëŒ€ë¹„</label>
        <label><input type="checkbox" id="optBig"/> í° ë²„íŠ¼</label>
        <label>ë–¨ë¦¼ ë³´ì •(ë””ë°”ìš´ìŠ¤ ms)
            <select id="optDebounce">
                <option value="0">êº¼ì§</option>
                <option value="120" selected>120</option>
                <option value="180">180</option>
                <option value="240">240</option>
            </select>
        </label>
        <label>ë¼ìš´ë“œ ìˆ˜
            <select id="optRounds">
                <option value="10" selected>10</option>
                <option value="6">6</option>
                <option value="15">15</option>
            </select>
        </label>
    </div>
</div>

<div class="card" aria-labelledby="playTitle">
    <h3 id="playTitle">3) í”Œë ˆì´</h3>
    <div class="panel">
        <button id="btnStart">ê²Œì„ ì‹œì‘</button>
        <div class="badge">ì§„í–‰: <span id="progress">0</span></div>
        <div class="badge">ì •ë‹µ: <span id="correct">0</span></div>
        <div class="badge">ì˜¤ë‹µ: <span id="wrong">0</span></div>
        <div class="badge">í‰ê· ë°˜ì‘(ms): <span id="avgMs">-</span></div>
    </div>

    <div style="margin-top:12px;">
        <span class="sr-only" id="targetLabel">ëª©í‘œ ìƒ‰ìƒ</span>
        <div id="targetSwatch" role="img" aria-labelledby="targetLabel"
             style="width:100%; height:60px; border-radius:12px; border:2px solid #222; background:#eee;"></div>
    </div>

    <div class="grid" style="margin-top:12px;">
        <!-- 4ìƒ‰ ë²„íŠ¼ -->
        <button class="color-btn" data-color="#E74C3C" aria-label="ë¶‰ì€ìƒ‰ ë²„íŠ¼"   style="background:#E74C3C;"></button>
        <button class="color-btn" data-color="#2ECC71" aria-label="ë…¹ìƒ‰ ë²„íŠ¼"     style="background:#2ECC71;"></button>
        <button class="color-btn" data-color="#3498DB" aria-label="íŒŒë€ìƒ‰ ë²„íŠ¼"   style="background:#3498DB;"></button>
        <button class="color-btn" data-color="#F1C40F" aria-label="ë…¸ë€ìƒ‰ ë²„íŠ¼"   style="background:#F1C40F;"></button>
    </div>

    <div class="panel" style="margin-top:12px;">
        <button id="btnEnd" disabled>ê°•ì œ ì¢…ë£Œ/ê¸°ë¡</button>
        <span id="gameStatus" class="badge" aria-live="polite"></span>
    </div>
</div>

<script>
    (() => {
      const $ = (id) => document.getElementById(id);
      const target = $('targetSwatch');
      const progress = $('progress'), correct = $('correct'), wrong = $('wrong'), avgMs = $('avgMs');
      const status = $('gameStatus');

      const COLORS = ['#E74C3C','#2ECC71','#3498DB','#F1C40F']; // ì , ë…¹, ì²­, í™©
      let sessionId = null;
      let startedAt = null;
      let round = 0, maxRounds = 10;
      let correctCnt = 0, wrongCnt = 0;
      let reactionSum = 0, reactions = [];
      let currentTarget = null;
      let debounceMs = 120;
      let lastTapAt = 0;
      let running = false;

      // ì ‘ê·¼ì„± ì˜µì…˜
      const root = document.documentElement;
      $('optContrast').addEventListener('change', e => {
        document.body.classList.toggle('contrast', e.target.checked);
      });
      $('optBig').addEventListener('change', e => {
        document.body.classList.toggle('big', e.target.checked);
      });
      $('optDebounce').addEventListener('change', e => {
        debounceMs = parseInt(e.target.value, 10) || 0;
      });
      $('optRounds').addEventListener('change', e => {
        maxRounds = parseInt(e.target.value, 10) || 10;
      });

      // ë¡œê·¸ì¸
      $('btnLogin').addEventListener('click', async () => {
        try {
          const data = await API.login($('id').value, $('pw').value);
          $('loginStatus').textContent = 'ë¡œê·¸ì¸ ì„±ê³µ';
        } catch (e) {
          $('loginStatus').textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
        }
      });

      // ê²Œì„ ì‹œì‘
      $('btnStart').addEventListener('click', async () => {
        if (!API.getToken()) { alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.'); return; }
        try {
          resetState();
          const meta = {
            contrast: $('optContrast').checked,
            bigButtons: $('optBig').checked,
            debounceMs: debounceMs,
            rounds: maxRounds
          };
          const res = await API.startSession('COLOR_TAP', meta);
          sessionId = res.sessionId;
          $('btnEnd').disabled = false;
          running = true;
          nextRound();
        } catch (e) {
          alert('ì„¸ì…˜ ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
        }
      });

      // ê°•ì œ ì¢…ë£Œ
      $('btnEnd').addEventListener('click', async () => {
        if (sessionId) await endAndReport();
      });

      // ë²„íŠ¼ íƒ­ í•¸ë“¤ëŸ¬
      [...document.querySelectorAll('.color-btn')].forEach(btn => {
        btn.addEventListener('pointerdown', onTap, {passive:true});
        btn.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') onTap(e); });
      });

      function onTap(e) {
        if (!running) return;
        const now = performance.now();
        if (debounceMs > 0 && now - lastTapAt < debounceMs) return; // ë–¨ë¦¼ ë³´ì •
        lastTapAt = now;

        const chosen = e.currentTarget.getAttribute('data-color');
        const rt = performance.now() - startedAt; // reaction time
        const hit = (chosen === currentTarget);
        reactions.push(rt);
        reactionSum += rt;
        if (hit) { correctCnt++; } else { wrongCnt++; }
        setStats();

        // ë¼ìš´ë“œ ì§„í–‰
        if (round >= maxRounds) {
          endAndReport();
        } else {
          nextRound();
        }
      }

      function nextRound() {
        round++;
        progress.textContent = `${round}/${maxRounds}`;
        // ìƒˆ íƒ€ê²Ÿ ê³ ë¥´ê¸°
        currentTarget = COLORS[Math.floor(Math.random()*COLORS.length)];
        target.style.background = currentTarget;
        target.setAttribute('aria-label', 'ëª©í‘œ ìƒ‰ìƒ ' + currentTarget);
        // ë°˜ì‘ íƒ€ì´ë¨¸ ì‹œì‘
        startedAt = performance.now();
      }

      async function endAndReport() {
        running = false;
        $('btnEnd').disabled = true;
        const avg = reactions.length ? Math.round(reactionSum / reactions.length) : null;
        const accuracy = (correctCnt + wrongCnt) ? (correctCnt / (correctCnt + wrongCnt)) : null;

        try {
          // ì§€í‘œ ì „ì†¡(ì›í•˜ë©´ ë¼ìš´ë“œë³„ ìƒì„¸ë¥¼ extraë¡œ ë³´ë‚¼ ìˆ˜ ìˆìŒ)
          await API.addMetrics(sessionId, [
            { key: 'taps', value: correctCnt + wrongCnt, unit: 'count' },
            { key: 'correct', value: correctCnt, unit: 'count' },
            { key: 'mistake', value: wrongCnt, unit: 'count' },
            { key: 'avgReactionMs', value: avg ?? 0, unit: 'ms' }
          ]);

          const endRes = await API.endSession(sessionId, {
            score: correctCnt * 10,               // ê°„ë‹¨ ì ìˆ˜ ê·œì¹™(ì •ë‹µÃ—10)
            accuracy: accuracy,                   // 0.0~1.0
            durationSec: null,                    // ì„œë²„ê°€ ìë™ ê³„ì‚°í•˜ë„ë¡ null
            meta: { lastAvgReactionMs: avg }
          });
          status.textContent = `ê¸°ë¡ ì €ì¥: ì ìˆ˜ ${endRes.score}, ì •í™•ë„ ${(endRes.accuracy ?? 0)*100|0}%`;
        } catch (e) {
          status.textContent = 'ê¸°ë¡ ì‹¤íŒ¨: ' + e.message;
        }
      }

      function resetState() {
        sessionId = null;
        round = 0; correctCnt = 0; wrongCnt = 0;
        reactionSum = 0; reactions = [];
        progress.textContent = '0';
        correct.textContent = '0';
        wrong.textContent = '0';
        avgMs.textContent = '-';
        status.textContent = '';
        lastTapAt = 0;
      }

      function setStats() {
        correct.textContent = String(correctCnt);
        wrong.textContent = String(wrongCnt);
        const avg = reactions.length ? Math.round(reactionSum / reactions.length) : '-';
        avgMs.textContent = String(avg);
      }
    })();
</script>
</body>
</html>