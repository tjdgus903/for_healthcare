<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Sequence Memory | Healthcare</title>
    <style>
        :root { --btn-size: 90px; --gap: 10px; }
        body { font-family: system-ui, sans-serif; max-width: 960px; margin: 24px auto; padding: 0 12px; }
        h1 { margin: 8px 0 16px; }
        .card { border:1px solid #ddd; border-radius:12px; padding:16px; margin:12px 0; }
        .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
        .panel { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
        input, button, select { padding:10px 12px; border:1px solid #bbb; border-radius:10px; font-size:16px; }
        button { cursor:pointer; }
        .grid { display:grid; grid-template-columns: repeat(4, minmax(80px, 1fr)); gap: var(--gap); margin-top: 12px; }
        .symbol-btn {
          height: var(--btn-size);
          border-radius: 16px;
          display:flex; align-items:center; justify-content:center;
          font-weight: 700; font-size: 18px; color: #111; border:2px solid #222;
          touch-action: manipulation; background:#f5f5f5;
        }
        .big .symbol-btn { height: calc(var(--btn-size) * 1.4); font-size: 22px; }
        .highlight { background: #ffeb99 !important; transition: background 120ms; }
        .badge { background:#efefef; padding:6px 10px; border-radius:999px; }
        .sr-only { position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0; }
    </style>
    <script defer src="/games/common.js"></script>
</head>
<body>
<h1>ğŸ§  Sequence Memory</h1>

<div class="card" aria-labelledby="loginTitle">
    <h3 id="loginTitle">1) ë¡œê·¸ì¸</h3>
    <div class="row">
        <label>ì•„ì´ë”” <input id="id" value="fhc"/></label>
        <label>ë¹„ë°€ë²ˆí˜¸ <input id="pw" value="fhc" type="password"/></label>
        <button id="btnLogin">ë¡œê·¸ì¸</button>
        <span id="loginStatus" class="badge" aria-live="polite"></span>
    </div>
</div>

<a href="/games/sequence-memory.html"><button>ğŸ§  Sequence Memory</button></a>

<div class="panel" style="margin-top:8px;">
    <span class="badge">HINT í† í°: <span id="hintBal">-</span></span>
    <button id="btnUseHint" disabled>íŒíŠ¸ ì‚¬ìš© (1)</button>
</div>

<div class="card" aria-labelledby="optTitle">
    <h3 id="optTitle">2) ì˜µì…˜</h3>
    <div class="panel">
        <label>ë¼ìš´ë“œ ìˆ˜
            <select id="optRounds">
                <option value="6" selected>6</option>
                <option value="8">8</option>
                <option value="10">10</option>
            </select>
        </label>
        <label>ì‹¬ë³¼ ì…‹
            <select id="optSymbolSet">
                <option value="RGYB" selected>R G Y B</option>
                <option value="RGYBOP">R G Y B O P</option>
            </select>
        </label>
        <label>ë³´ì—¬ì£¼ê¸° ì†ë„(ms)
            <select id="optShowMs">
                <option value="900">900</option>
                <option value="800" selected>800</option>
                <option value="700">700</option>
            </select>
        </label>
        <label>ì…ë ¥ ì œí•œ(ms)
            <select id="optTimeout">
                <option value="6000" selected>6000</option>
                <option value="5000">5000</option>
                <option value="4000">4000</option>
            </select>
        </label>
        <label><input type="checkbox" id="optBig"/> í° ë²„íŠ¼</label>
    </div>
</div>

<div class="card" aria-labelledby="playTitle">
    <h3 id="playTitle">3) í”Œë ˆì´</h3>
    <div class="panel">
        <button id="btnStart">ì‹œì‘</button>
        <div class="badge">ë¼ìš´ë“œ: <span id="round">-</span></div>
        <div class="badge">ì„±ê³µ: <span id="succ">0</span></div>
        <div class="badge">ì‹¤íŒ¨: <span id="fail">0</span></div>
        <div class="badge">í‰ê·  ì…ë ¥(ms): <span id="avgMs">-</span></div>
    </div>

    <div class="grid" style="margin-top:12px;">
        <!-- ì‹¬ë³¼ 6ê°œê¹Œì§€ ëŒ€ë¹„, ê¸°ë³¸ 4ê°œ -->
        <button class="symbol-btn" data-sym="R" aria-label="R">R</button>
        <button class="symbol-btn" data-sym="G" aria-label="G">G</button>
        <button class="symbol-btn" data-sym="Y" aria-label="Y">Y</button>
        <button class="symbol-btn" data-sym="B" aria-label="B">B</button>
        <button class="symbol-btn" data-sym="O" aria-label="O" style="display:none;">O</button>
        <button class="symbol-btn" data-sym="P" aria-label="P" style="display:none;">P</button>
    </div>

    <div class="panel" style="margin-top:12px;">
        <button id="btnEnd" disabled>ê°•ì œ ì¢…ë£Œ/ê¸°ë¡</button>
        <span id="status" class="badge" aria-live="polite"></span>
    </div>
</div>

<script>
    (() => {
      const $ = (id) => document.getElementById(id);
      const symButtons = [...document.querySelectorAll('.symbol-btn')];

      let sessionId = null;
      let totalRounds = 6;
      let symbolSet = ['R','G','Y','B'];
      let roundIndex = 0;
      let showing = false; // ë³´ì—¬ì£¼ê¸° ë‹¨ê³„ì¸ì§€
      let taking = false;  // ì…ë ¥ ë‹¨ê³„ì¸ì§€
      let expect = [];     // í˜„ì¬ ë¼ìš´ë“œ ì •ë‹µ ì‹œí€€ìŠ¤
      let attempt = [];    // ì‚¬ìš©ìê°€ ëˆ„ë¥¸ ì‹œí€€ìŠ¤
      let succ = 0, fail = 0;
      let inputTimes = []; // ë¼ìš´ë“œ ì…ë ¥ ì‹œê°„(ms)
      let startedInputAt = 0;

      // ì˜µì…˜ ë°˜ì˜
      $('optBig').addEventListener('change', e => {
        document.body.classList.toggle('big', e.target.checked);
      });
      $('optSymbolSet').addEventListener('change', e => {
        const val = e.target.value;
        symbolSet = (val === 'RGYB') ? ['R','G','Y','B'] : ['R','G','Y','B','O','P'];
        // ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
        symButtons.forEach(btn => {
          const s = btn.getAttribute('data-sym');
          btn.style.display = symbolSet.includes(s) ? '' : 'none';
        });
      });

      function reset() {
        sessionId = null;
        roundIndex = 0;
        succ = 0; fail = 0; inputTimes = [];
        expect = []; attempt = [];
        showing = false; taking = false;
        $('round').textContent = '-';
        $('succ').textContent = '0';
        $('fail').textContent = '0';
        $('avgMs').textContent = '-';
        $('status').textContent = '';
        $('btnEnd').disabled = true;
      }

      function setStats() {
        $('succ').textContent = String(succ);
        $('fail').textContent = String(fail);
        const avg = inputTimes.length ? Math.round(inputTimes.reduce((a,b)=>a+b,0)/inputTimes.length) : '-';
        $('avgMs').textContent = String(avg);
      }

      // ë¡œê·¸ì¸
      $('btnLogin').addEventListener('click', async () => {
        try {
          await API.login($('id').value, $('pw').value);
          $('loginStatus').textContent = 'ë¡œê·¸ì¸ ì„±ê³µ';
        } catch (e) {
          $('loginStatus').textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
        }
      });

      // ì‹œì‘
      $('btnStart').addEventListener('click', async () => {
        if (!API.getToken()) { alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.'); return; }
        try {
          reset();
          totalRounds = parseInt($('optRounds').value, 10);
          const showMs = parseInt($('optShowMs').value, 10);
          const inputTimeoutMs = parseInt($('optTimeout').value, 10);
          // symbolSetì€ ì…€ë ‰íŠ¸ í•¸ë“¤ëŸ¬ë¡œ ì´ë¯¸ ë°˜ì˜ë¨

          const res = await API.request('/sequence/start', {
            method: 'POST',
            body: {
              totalRounds, symbolSet, showMs, inputTimeoutMs
            }
          });

          sessionId = res.sessionId;
          $('btnEnd').disabled = false;
          roundIndex = res.roundIndex;
          $('round').textContent = `${roundIndex}/${totalRounds}`;
          expect = res.pattern;
          await playShowPhase(expect, showMs);
          startInputPhase();
        } catch (e) {
          alert('ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
        }
      });

      // ê°•ì œ ì¢…ë£Œ
      $('btnEnd').addEventListener('click', async () => {
        if (sessionId) await finalize();
      });

      // ì…ë ¥ ë²„íŠ¼
      symButtons.forEach(btn => {
        btn.addEventListener('pointerdown', onTap, {passive:true});
        btn.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') onTap(e); });
      });

      function onTap(e) {
        if (!taking) return;
        const sym = e.currentTarget.getAttribute('data-sym');
        attempt.push(sym);
        // ëª¨ë“  ì…ë ¥ ì™„ë£Œ ì‹œ íŒì •
        if (attempt.length >= expect.length) {
          taking = false;
          const reactionMs = Math.round(performance.now() - startedInputAt);
          inputTimes.push(reactionMs);
          judgeRound(reactionMs);
        }
      }

      async function playShowPhase(seq, showMs) {
        showing = true;
        // í•˜ì´ë¼ì´íŠ¸ í‘œì‹œ(í•œ ê°œì”©)
        for (let i=0; i<seq.length; i++) {
          const s = seq[i];
          const btn = symButtons.find(b => b.getAttribute('data-sym') === s);
          if (!btn) continue;
          btn.classList.add('highlight');
          await wait(showMs);
          btn.classList.remove('highlight');
          await wait(200);
        }
        showing = false;
      }

      function startInputPhase() {
        attempt = [];
        startedInputAt = performance.now();
        taking = true;
        $('status').textContent = `ì…ë ¥ ëŒ€ê¸°: ${expect.length}ê°œ`;
      }

      async function judgeRound(reactionMs) {
        try {
          const r = await API.request(`/sequence/${sessionId}/submit`, {
            method: 'POST',
            body: { roundIndex, attempt, reactionMs }
          });
          if (r.correct) succ++; else fail++;
          setStats();

          if (r.finished) {
            await finalize();
          } else {
            // ë‹¤ìŒ ë¼ìš´ë“œ
            roundIndex = r.nextRound;
            $('round').textContent = `${roundIndex}/${totalRounds}`;
            const patt = await API.request(`/sequence/${sessionId}/pattern?roundIndex=${roundIndex}`);
            expect = patt.pattern;
            const showMs = parseInt($('optShowMs').value, 10);
            await playShowPhase(expect, showMs);
            startInputPhase();
          }
        } catch (e) {
          $('status').textContent = 'íŒì • ì‹¤íŒ¨: ' + e.message;
        }
      }

      async function finalize() {
        const avg = inputTimes.length ? Math.round(inputTimes.reduce((a,b)=>a+b,0)/inputTimes.length) : null;
        // maxLevel: ì„±ê³µí•œ ë¼ìš´ë“œ ìˆ˜ (ê°„ë‹¨ ê³„ì‚°)
        const maxLevel = succ;
        try {
          const res = await API.request(`/sequence/${sessionId}/end`, {
            method: 'POST',
            body: {
              maxLevel, totalRounds, successCount: succ, failCount: fail, avgInputMs: avg
            }
          });
          $('status').textContent = `ê¸°ë¡ ì €ì¥: ì ìˆ˜ ${res.score}, ì •í™•ë„ ${Math.round((res.accuracy ?? 0)*100)}%`;
        } catch (e) {
          $('status').textContent = 'ê¸°ë¡ ì‹¤íŒ¨: ' + e.message;
        } finally {
          taking = false; showing = false;
          $('btnEnd').disabled = true;
        }
      }

      async function refreshInventory() {
        const inv = await API.getMyInventory();
        document.getElementById('hintBal').textContent = String(inv.hintTokens ?? 0);
        // íŒíŠ¸ ë²„íŠ¼ í™œì„±í™” ì¡°ê±´: ì…ë ¥ ë‹¨ê³„(taking) && í† í°>0
        document.getElementById('btnUseHint').disabled = !(taking && (inv.hintTokens ?? 0) > 0);
      }

      // ë¡œê·¸ì¸ í›„ ì¸ë²¤í† ë¦¬ í•œë²ˆ ì¡°íšŒ
      $('btnLogin').addEventListener('click', async () => {
        try {
          await API.login($('id').value, $('pw').value);
          $('loginStatus').textContent = 'ë¡œê·¸ì¸ ì„±ê³µ';
          await refreshInventory();
        } catch (e) {
          $('loginStatus').textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
        }
      });

      // ì‹œì‘ ì‹œì—ë„ ìƒˆë¡œê³ ì¹¨
      $('btnStart').addEventListener('click', async () => {
        // ... ê¸°ì¡´ ì‹œì‘ ë¡œì§ ...
        await refreshInventory();
      });

      // ë¼ìš´ë“œê°€ ë„˜ì–´ê°ˆ ë•Œë§ˆë‹¤ ì¸ë²¤í† ë¦¬ ë²„íŠ¼ ìƒíƒœ ê°±ì‹ 
      function startInputPhase() {
        attempt = [];
        startedInputAt = performance.now();
        taking = true;
        $('status').textContent = `ì…ë ¥ ëŒ€ê¸°: ${expect.length}ê°œ`;
        refreshInventory().catch(()=>{});
      }

      // íŒíŠ¸ ì‚¬ìš©
      document.getElementById('btnUseHint').addEventListener('click', async () => {
      if (!taking) return;
      try {
        // 1) í† í° ì°¨ê°
        const r = await API.spendToken({ rewardType: 'HINT', amount: 1 });
        document.getElementById('hintBal').textContent = String(r.newBalance.hintTokens ?? 0);

        // 2) ë‹¤ìŒ ì…ë ¥í•´ì•¼ í•  ì‹¬ë³¼ í•˜ì´ë¼ì´íŠ¸
        const nextIdx = attempt.length; // ì•„ì§ ì…ë ¥í•˜ì§€ ì•Šì€ ìœ„ì¹˜
        const sym = expect[nextIdx];
        const btn = [...document.querySelectorAll('.symbol-btn')].find(b => b.getAttribute('data-sym') === sym);
        if (btn) {
          btn.classList.add('highlight');
          await wait(700);
          btn.classList.remove('highlight');
        }

        // 3) (ì„ íƒ) ì„œë²„ ë©”íŠ¸ë¦­ ë¡œê·¸
        if (window.fetch) {
          API.post(`/sequence/${sessionId}/hint-used?roundIndex=${roundIndex}`).catch(()=>{});
        }
      } catch (e) {
        alert('íŒíŠ¸ ì‚¬ìš© ì‹¤íŒ¨: ' + e.message);
      }
      });

      function wait(ms){ return new Promise(r => setTimeout(r, ms)); }
    })();
</script>
</body>
</html>